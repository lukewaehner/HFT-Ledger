<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HFT Exchange</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f7f8fa;
        color: #2d3748;
        line-height: 1.5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e2e8f0;
      }

      .header h1 {
        font-size: 2rem;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 8px;
      }

      .status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 500;
      }

      .status.connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .main-grid {
        display: grid;
        grid-template-columns: minmax(280px, 320px) 1fr minmax(280px, 320px);
        gap: 20px;
        margin-bottom: 20px;
      }

      @media (max-width: 1200px) {
        .main-grid {
          grid-template-columns: 1fr;
          gap: 16px;
        }
      }

      .panel {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .panel h3 {
        margin-bottom: 16px;
        font-size: 1.125rem;
        font-weight: 600;
        color: #2d3748;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .icon {
        width: 16px;
        height: 16px;
        display: inline-block;
      }

      .order-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      label {
        font-weight: 500;
        color: #374151;
        font-size: 0.875rem;
      }

      input,
      select,
      button {
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
        width: 100%;
        box-sizing: border-box;
      }

      input,
      select {
        background: #ffffff;
        color: #2d3748;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      button {
        background: #f9fafb;
        color: #374151;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
        border: 1px solid #d1d5db;
      }

      button:hover {
        background: #f3f4f6;
      }

      .buy-btn {
        background: #dcfce7;
        color: #166534;
        border-color: #bbf7d0;
      }

      .buy-btn:hover {
        background: #bbf7d0;
      }

      .sell-btn {
        background: #fee2e2;
        color: #991b1b;
        border-color: #fecaca;
      }

      .sell-btn:hover {
        background: #fecaca;
      }

      .orderbook {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        max-height: 400px;
        overflow-y: auto;
      }

      .asks,
      .bids {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 12px;
      }

      .asks h4 {
        color: #dc2626;
        text-align: center;
        margin-bottom: 12px;
        font-size: 0.875rem;
        font-weight: 600;
      }

      .bids h4 {
        color: #16a34a;
        text-align: center;
        margin-bottom: 12px;
        font-size: 0.875rem;
        font-weight: 600;
      }

      .price-level {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 8px;
        padding: 4px 8px;
        margin: 2px 0;
        border-radius: 2px;
        font-family: "SF Mono", Monaco, "Cascadia Code", monospace;
        font-size: 0.75rem;
      }

      .ask-level {
        background: rgba(220, 38, 38, 0.05);
      }

      .bid-level {
        background: rgba(22, 163, 74, 0.05);
      }

      .trades-panel {
        max-height: 400px;
        overflow-y: auto;
      }

      .trade-item {
        display: grid;
        grid-template-columns: 60px 1fr 1fr 80px;
        gap: 8px;
        padding: 6px 8px;
        margin: 2px 0;
        background: #f8fafc;
        border-radius: 4px;
        font-family: "SF Mono", Monaco, "Cascadia Code", monospace;
        font-size: 0.75rem;
        border-left: 2px solid transparent;
      }

      .trade-buy {
        border-left-color: #16a34a;
      }

      .trade-sell {
        border-left-color: #dc2626;
      }

      .bottom-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .log {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 12px;
        max-height: 200px;
        overflow-y: auto;
        font-family: "SF Mono", Monaco, "Cascadia Code", monospace;
        font-size: 0.75rem;
      }

      .log-entry {
        margin: 2px 0;
        padding: 2px 4px;
      }

      .log-info {
        color: #1f2937;
      }

      .log-success {
        color: #166534;
      }

      .log-error {
        color: #991b1b;
      }

      .market-data {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .metric {
        text-align: center;
        padding: 16px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
      }

      .metric-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2d3748;
        font-family: "SF Mono", Monaco, "Cascadia Code", monospace;
      }

      .metric-label {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 4px;
        font-weight: 500;
      }

      .empty-state {
        text-align: center;
        color: #6b7280;
        font-size: 0.875rem;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>HFT Exchange</h1>
        <div class="status" id="status">Disconnected</div>
      </div>

      <div class="main-grid">
        <!-- Order Submission Panel -->
        <div class="panel">
          <h3>
            <svg class="icon" viewBox="0 0 16 16" fill="currentColor">
              <path
                d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"
              />
            </svg>
            Submit Order
          </h3>
          <div class="order-form">
            <div class="form-group">
              <label for="symbol">Symbol</label>
              <input
                type="text"
                id="symbol"
                value="AAPL"
                placeholder="e.g., AAPL"
              />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="price">Price (ticks)</label>
                <input
                  type="number"
                  id="price"
                  value="10000"
                  placeholder="10000"
                />
              </div>
              <div class="form-group">
                <label for="quantity">Quantity</label>
                <input
                  type="number"
                  id="quantity"
                  value="100"
                  placeholder="100"
                />
              </div>
            </div>

            <div class="form-row">
              <button class="buy-btn" onclick="submitOrder('Bid')">BUY</button>
              <button class="sell-btn" onclick="submitOrder('Ask')">
                SELL
              </button>
            </div>
          </div>
        </div>

        <!-- Order Book Panel -->
        <div class="panel">
          <h3>
            <svg class="icon" viewBox="0 0 16 16" fill="currentColor">
              <path
                d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"
              />
            </svg>
            Order Book
          </h3>
          <div class="orderbook">
            <div class="asks">
              <h4>ASKS (Sell)</h4>
              <div id="asks-list">
                <div class="empty-state">No asks</div>
              </div>
            </div>
            <div class="bids">
              <h4>BIDS (Buy)</h4>
              <div id="bids-list">
                <div class="empty-state">No bids</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Trades Panel -->
        <div class="panel">
          <h3>
            <svg class="icon" viewBox="0 0 16 16" fill="currentColor">
              <path
                d="M11.251.068a.5.5 0 0 1 .227.58L9.677 6.5H13a.5.5 0 0 1 .364.843l-8 8.5a.5.5 0 0 1-.842-.49L6.323 9.5H3a.5.5 0 0 1-.364-.843l8-8.5a.5.5 0 0 1 .615-.09z"
              />
            </svg>
            Recent Trades
          </h3>
          <div class="trades-panel" id="trades-list">
            <div class="empty-state">No trades yet</div>
          </div>
        </div>
      </div>

      <div class="bottom-grid">
        <!-- Market Data Panel -->
        <div class="panel">
          <h3>
            <svg class="icon" viewBox="0 0 16 16" fill="currentColor">
              <path
                d="M8.39 12.648a1.32 1.32 0 0 0-.015.18c0 .305.21.508.5.508.266 0 .492-.172.555-.477l.554-2.703h1.204c.421 0 .617-.234.617-.547 0-.312-.188-.53-.617-.53h-.985l.516-2.524h1.265c.43 0 .618-.227.618-.547 0-.313-.188-.524-.618-.524h-1.046l.476-2.304a1.06 1.06 0 0 0 .016-.164.51.51 0 0 0-.516-.516.54.54 0 0 0-.539.43l-.523 2.554H7.617l.477-2.304c.008-.04.015-.118.015-.164a.512.512 0 0 0-.523-.516.539.539 0 0 0-.531.43L6.53 5.484H5.414c-.43 0-.617.22-.617.532 0 .312.187.539.617.539h.906l-.515 2.523H4.609c-.421 0-.609.219-.609.531 0 .313.188.547.61.547h.976l-.516 2.492c-.008.04-.015.125-.015.18 0 .305.21.508.5.508.265 0 .492-.172.554-.477l.555-2.703h2.242Zm-1-6.109h2.266l-.515 2.563H6.859l.532-2.563Z"
              />
            </svg>
            Market Data
          </h3>
          <div class="market-data">
            <div class="metric">
              <div class="metric-value" id="best-bid">-</div>
              <div class="metric-label">Best Bid</div>
            </div>
            <div class="metric">
              <div class="metric-value" id="best-ask">-</div>
              <div class="metric-label">Best Ask</div>
            </div>
            <div class="metric">
              <div class="metric-value" id="spread">-</div>
              <div class="metric-label">Spread</div>
            </div>
            <div class="metric">
              <div class="metric-value" id="last-price">-</div>
              <div class="metric-label">Last Price</div>
            </div>
          </div>
        </div>

        <!-- Activity Log Panel -->
        <div class="panel">
          <h3>
            <svg class="icon" viewBox="0 0 16 16" fill="currentColor">
              <path
                d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"
              />
            </svg>
            Activity Log
          </h3>
          <div class="log" id="activity-log"></div>
        </div>
      </div>
    </div>

    <script>
      let tradeSocket = null;
      let depthSocket = null;
      let currentSymbol = "AAPL";

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        log("HFT Exchange Interface Loaded", "info");
        connectWebSockets();
        loadInitialData();
      });

      // Connect to WebSocket streams
      function connectWebSockets() {
        const baseWs = "ws://localhost:8080";

        // Trade stream
        tradeSocket = new WebSocket(
          `${baseWs}/symbols/${currentSymbol}/trades/stream`
        );

        tradeSocket.onopen = function () {
          log("Trade stream connected", "success");
          updateStatus();
        };

        tradeSocket.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data);
            console.log("Trade message:", data);
            if (data.Trade) {
              handleTradeUpdate(data.Trade);
            }
          } catch (e) {
            console.error("Error parsing trade message:", e);
          }
        };

        tradeSocket.onerror = function (error) {
          log("Trade stream error: " + error, "error");
          updateStatus();
        };

        // Depth stream
        depthSocket = new WebSocket(
          `${baseWs}/symbols/${currentSymbol}/depth/stream`
        );

        depthSocket.onopen = function () {
          log("Depth stream connected", "success");
          updateStatus();
        };

        depthSocket.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data);
            console.log("Depth message:", data);
            if (data.Depth) {
              handleDepthUpdate(data.Depth);
            }
          } catch (e) {
            console.error("Error parsing depth message:", e);
          }
        };

        depthSocket.onerror = function (error) {
          log("Depth stream error: " + error, "error");
          updateStatus();
        };
      }

      // Submit order
      async function submitOrder(side) {
        const symbol = document.getElementById("symbol").value;
        const price = parseInt(document.getElementById("price").value);
        const quantity = parseInt(document.getElementById("quantity").value);

        const order = {
          side: side,
          price: price,
          quantity: quantity,
        };

        try {
          log(`Submitting ${side} order: ${quantity} @ ${price}`, "info");

          const response = await fetch(
            `http://localhost:8080/symbols/${symbol}/orders`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(order),
            }
          );

          const result = await response.json();
          console.log("Order response:", result);

          if (response.ok) {
            log(
              `Order submitted: ${side} ${quantity} @ ${price} (${result.status})`,
              "success"
            );
            if (result.trades && result.trades.length > 0) {
              log(`Generated ${result.trades.length} trade(s)`, "success");
              // Handle trades from order response
              result.trades.forEach((trade) => {
                addTradeToList(trade);
                updateLastPrice(trade.px_ticks);
              });
            }
            // Refresh market data after order
            setTimeout(loadInitialData, 100);
          } else {
            log(`Order failed: ${result.error}`, "error");
          }
        } catch (error) {
          log(`Network error: ${error.message}`, "error");
          console.error("Order submission error:", error);
        }
      }

      // Load initial market data
      async function loadInitialData() {
        try {
          // Load order book depth
          const depthResponse = await fetch(
            `http://localhost:8080/symbols/${currentSymbol}/depth?levels=10`
          );
          if (depthResponse.ok) {
            const depth = await depthResponse.json();
            console.log("Initial depth data:", depth);
            updateOrderBook(depth);
            updateBestPrices(depth);
          } else {
            console.error("Failed to load depth data:", depthResponse.status);
          }
        } catch (error) {
          log(`Failed to load initial data: ${error.message}`, "error");
          console.error("Load initial data error:", error);
        }
      }

      // Handle trade updates
      function handleTradeUpdate(tradeEvent) {
        console.log("Handling trade update:", tradeEvent);
        const trade = tradeEvent.trade;
        addTradeToList(trade);
        updateLastPrice(trade.px_ticks);
        log(`Trade: ${trade.qty} @ ${trade.px_ticks}`, "info");
      }

      // Handle depth updates
      function handleDepthUpdate(depthUpdate) {
        console.log("Handling depth update:", depthUpdate);
        updateOrderBook(depthUpdate);
        updateBestPrices(depthUpdate);
      }

      // Update order book display
      function updateOrderBook(depth) {
        const asksList = document.getElementById("asks-list");
        const bidsList = document.getElementById("bids-list");

        // Update asks (reverse order - highest first)
        asksList.innerHTML = "";
        if (depth.asks && depth.asks.length > 0) {
          depth.asks
            .slice()
            .reverse()
            .forEach((level) => {
              const div = document.createElement("div");
              div.className = "price-level ask-level";
              div.innerHTML = `
                        <span>${level.price}</span>
                        <span>${level.quantity}</span>
                        <span>${level.orders}</span>
                    `;
              asksList.appendChild(div);
            });
        } else {
          asksList.innerHTML = '<div class="empty-state">No asks</div>';
        }

        // Update bids (highest first)
        bidsList.innerHTML = "";
        if (depth.bids && depth.bids.length > 0) {
          depth.bids.forEach((level) => {
            const div = document.createElement("div");
            div.className = "price-level bid-level";
            div.innerHTML = `
                        <span>${level.price}</span>
                        <span>${level.quantity}</span>
                        <span>${level.orders}</span>
                    `;
            bidsList.appendChild(div);
          });
        } else {
          bidsList.innerHTML = '<div class="empty-state">No bids</div>';
        }
      }

      // Update best prices
      function updateBestPrices(depth) {
        const bestBid =
          depth.bids && depth.bids.length > 0 ? depth.bids[0].price : "-";
        const bestAsk =
          depth.asks && depth.asks.length > 0 ? depth.asks[0].price : "-";

        document.getElementById("best-bid").textContent = bestBid;
        document.getElementById("best-ask").textContent = bestAsk;

        if (bestBid !== "-" && bestAsk !== "-") {
          const spread = bestAsk - bestBid;
          document.getElementById("spread").textContent = spread;
        } else {
          document.getElementById("spread").textContent = "-";
        }
      }

      // Add trade to list
      function addTradeToList(trade) {
        const tradesList = document.getElementById("trades-list");

        // Remove empty state if present
        const emptyState = tradesList.querySelector(".empty-state");
        if (emptyState) {
          emptyState.remove();
        }

        const div = document.createElement("div");
        div.className = `trade-item trade-buy`; // Default to buy styling

        const time = new Date().toLocaleTimeString();
        div.innerHTML = `
                <span>${time}</span>
                <span>${trade.px_ticks}</span>
                <span>${trade.qty}</span>
                <span>EXEC</span>
            `;

        tradesList.insertBefore(div, tradesList.firstChild);

        // Keep only last 20 trades
        while (tradesList.children.length > 20) {
          tradesList.removeChild(tradesList.lastChild);
        }
      }

      // Update last price
      function updateLastPrice(price) {
        document.getElementById("last-price").textContent = price;
      }

      // Update connection status
      function updateStatus() {
        const status = document.getElementById("status");
        const isConnected =
          tradeSocket?.readyState === WebSocket.OPEN &&
          depthSocket?.readyState === WebSocket.OPEN;

        if (isConnected) {
          status.textContent = "Connected";
          status.className = "status connected";
        } else {
          status.textContent = "Disconnected";
          status.className = "status disconnected";
        }
      }

      // Log activity
      function log(message, type = "info") {
        const logDiv = document.getElementById("activity-log");
        const entry = document.createElement("div");
        entry.className = `log-entry log-${type}`;
        entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;

        logDiv.insertBefore(entry, logDiv.firstChild);

        // Keep only last 50 entries
        while (logDiv.children.length > 50) {
          logDiv.removeChild(logDiv.lastChild);
        }
      }

      // Handle symbol change
      document.getElementById("symbol").addEventListener("change", function () {
        currentSymbol = this.value;
        log(`Switched to symbol: ${currentSymbol}`, "info");

        // Reconnect WebSockets for new symbol
        if (tradeSocket) tradeSocket.close();
        if (depthSocket) depthSocket.close();

        setTimeout(connectWebSockets, 1000);
        setTimeout(loadInitialData, 1500);
      });
    </script>
  </body>
</html>
