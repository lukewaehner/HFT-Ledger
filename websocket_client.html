<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HFT Exchange - Market Data</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #fafafa;
        color: #2c3e50;
        line-height: 1.5;
        padding: 24px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      h1 {
        font-size: 28px;
        font-weight: 300;
        text-align: center;
        margin-bottom: 32px;
        color: #34495e;
        letter-spacing: -0.5px;
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-bottom: 32px;
        flex-wrap: wrap;
      }

      button {
        background: white;
        color: #34495e;
        border: 1px solid #e1e8ed;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      button:hover {
        background: #f8f9fa;
        border-color: #d1d9e0;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      }

      button:active {
        transform: translateY(1px);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      button:disabled {
        background: #f5f5f5;
        color: #95a5a6;
        cursor: not-allowed;
        border-color: #ecf0f1;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 24px;
        margin-bottom: 32px;
      }

      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .market-overview {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        border: 1px solid #f1f3f4;
      }

      .card h2 {
        font-size: 18px;
        font-weight: 500;
        margin-bottom: 16px;
        color: #2c3e50;
      }

      .order-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .form-group label {
        font-size: 13px;
        color: #7f8c8d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      input,
      select {
        padding: 12px;
        border: 1px solid #e1e8ed;
        border-radius: 6px;
        font-size: 14px;
        background: white;
        transition: border-color 0.2s ease;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      }

      .submit-btn {
        background: #3498db;
        color: white;
        border: 1px solid #3498db;
        padding: 14px;
        font-weight: 600;
        margin-top: 8px;
      }

      .submit-btn:hover {
        background: #2980b9;
        border-color: #2980b9;
      }

      .quick-orders {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 12px;
      }

      .quick-btn {
        padding: 8px 12px;
        font-size: 12px;
        border-radius: 6px;
      }

      .quick-btn.bid {
        background: #d5f4e6;
        color: #27ae60;
        border-color: #27ae60;
      }

      .quick-btn.ask {
        background: #fdeaea;
        color: #e74c3c;
        border-color: #e74c3c;
      }

      .market-data {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .metric {
        padding: 12px 0;
        border-bottom: 1px solid #f8f9fa;
      }

      .metric:last-child {
        border-bottom: none;
      }

      .metric-label {
        font-size: 13px;
        color: #7f8c8d;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .metric-value {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
      }

      .bid {
        color: #27ae60;
      }
      .ask {
        color: #e74c3c;
      }

      .status {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        display: inline-block;
      }

      .connected {
        background: #d5f4e6;
        color: #27ae60;
      }

      .disconnected {
        background: #ffeaa7;
        color: #e17055;
      }

      .streams {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .stream-card {
        background: white;
        border-radius: 12px;
        border: 1px solid #f1f3f4;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      }

      .stream-header {
        padding: 20px 24px 16px;
        border-bottom: 1px solid #f8f9fa;
        background: #fcfcfc;
      }

      .stream-header h3 {
        font-size: 16px;
        font-weight: 500;
        color: #2c3e50;
        margin-bottom: 8px;
      }

      .log {
        height: 320px;
        overflow-y: auto;
        padding: 16px 24px;
        background: #fdfdfd;
        font-family: "SF Mono", Monaco, "Cascadia Code", monospace;
        font-size: 12px;
        line-height: 1.6;
      }

      .log-entry {
        margin-bottom: 8px;
        padding: 6px 0;
      }

      .timestamp {
        color: #95a5a6;
        font-size: 11px;
      }

      .trade-event {
        color: #e67e22;
        font-weight: 500;
      }

      .depth-event {
        color: #3498db;
        font-weight: 500;
      }

      .connection-event {
        color: #27ae60;
        font-weight: 500;
      }

      .error-event {
        color: #e74c3c;
        font-weight: 500;
      }

      .match-highlight {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding-left: 8px;
        margin: 4px 0;
      }

      .demo-section {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #f1f3f4;
      }

      .demo-section h4 {
        font-size: 14px;
        color: #34495e;
        margin-bottom: 12px;
        font-weight: 500;
      }

      @media (max-width: 1200px) {
        .main-grid {
          grid-template-columns: 1fr;
        }

        .streams {
          grid-template-columns: 1fr;
        }

        .controls {
          flex-direction: column;
          align-items: center;
        }

        button {
          width: 200px;
        }
      }

      .fade-in {
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>HFT Exchange Market Data</h1>

      <div class="controls">
        <button onclick="connectTrades()">Connect Trades</button>
        <button onclick="connectDepth()">Connect Depth</button>
        <button onclick="disconnectAll()">Disconnect</button>
        <button onclick="clearLogs()">Clear Logs</button>
      </div>

      <div class="main-grid">
        <div class="sidebar">
          <div class="card">
            <h2>Submit Order</h2>
            <form class="order-form" onsubmit="submitCustomOrder(event)">
              <div class="form-group">
                <label>Symbol</label>
                <select id="symbol">
                  <option value="AAPL">AAPL</option>
                  <option value="TSLA">TSLA</option>
                  <option value="MSFT">MSFT</option>
                  <option value="NVDA">NVDA</option>
                  <option value="GOOGL">GOOGL</option>
                </select>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Side</label>
                  <select id="side">
                    <option value="Bid">Buy (Bid)</option>
                    <option value="Ask">Sell (Ask)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Quantity</label>
                  <input
                    type="number"
                    id="quantity"
                    value="100"
                    min="1"
                    step="1"
                  />
                </div>
              </div>

              <div class="form-group">
                <label>Price (ticks)</label>
                <input
                  type="number"
                  id="price"
                  value="15000"
                  min="1"
                  step="1"
                />
              </div>

              <button type="submit" class="submit-btn">Submit Order</button>
            </form>

            <div class="demo-section">
              <h4>Quick Demo Orders</h4>
              <div class="quick-orders">
                <button
                  class="quick-btn bid"
                  onclick="quickOrder('Bid', 15000, 100)"
                >
                  Buy 100 @ 15000
                </button>
                <button
                  class="quick-btn ask"
                  onclick="quickOrder('Ask', 15000, 100)"
                >
                  Sell 100 @ 15000
                </button>
                <button
                  class="quick-btn bid"
                  onclick="quickOrder('Bid', 14950, 50)"
                >
                  Buy 50 @ 14950
                </button>
                <button
                  class="quick-btn ask"
                  onclick="quickOrder('Ask', 15050, 50)"
                >
                  Sell 50 @ 15050
                </button>
              </div>
              <div style="margin-top: 12px">
                <button
                  class="quick-btn"
                  onclick="demoMatching()"
                  style="
                    width: 100%;
                    background: #e8f5e8;
                    color: #27ae60;
                    border-color: #27ae60;
                  "
                >
                  Demo Price Matching
                </button>
              </div>
            </div>
          </div>

          <div class="card">
            <h2>AAPL Market</h2>
            <div class="market-data">
              <div class="metric">
                <div class="metric-label">Best Bid</div>
                <div class="metric-value bid" id="bestBid">--</div>
              </div>
              <div class="metric">
                <div class="metric-label">Best Ask</div>
                <div class="metric-value ask" id="bestAsk">--</div>
              </div>
              <div class="metric">
                <div class="metric-label">Spread</div>
                <div class="metric-value" id="spread">--</div>
              </div>
              <div class="metric">
                <div class="metric-label">Last Update</div>
                <div class="metric-value" id="lastUpdate">--</div>
              </div>
            </div>
          </div>

          <div class="card">
            <h2>Connection Status</h2>
            <div id="tradeStatus" class="status disconnected">Trade Stream</div>
            <div id="depthStatus" class="status disconnected">Depth Stream</div>
          </div>
        </div>

        <div class="market-overview">
          <div class="streams">
            <div class="stream-card">
              <div class="stream-header">
                <h3>Trade Stream</h3>
              </div>
              <div id="tradeLog" class="log">
                <div class="log-entry">
                  <span class="timestamp">Waiting for connection...</span>
                </div>
              </div>
            </div>

            <div class="stream-card">
              <div class="stream-header">
                <h3>Market Depth</h3>
              </div>
              <div id="depthLog" class="log">
                <div class="log-entry">
                  <span class="timestamp">Waiting for connection...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let tradeSocket = null;
      let depthSocket = null;

      function updateStatus(type, connected) {
        const element = document.getElementById(type + "Status");
        element.className = `status ${
          connected ? "connected" : "disconnected"
        }`;
        element.textContent = connected ? `${type} Stream` : `${type} Stream`;
      }

      function logMessage(type, message, eventType = "info") {
        const log = document.getElementById(type + "Log");
        const timestamp = new Date().toLocaleTimeString();

        const entry = document.createElement("div");
        entry.className = "log-entry fade-in";

        const eventClass =
          {
            trade: "trade-event",
            depth: "depth-event",
            connection: "connection-event",
            error: "error-event",
            match: "match-highlight",
          }[eventType] || "";

        entry.innerHTML = `
                <div class="timestamp">${timestamp}</div>
                <div class="${eventClass}">${message}</div>
            `;

        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;

        // Keep only last 50 entries
        while (log.children.length > 50) {
          log.removeChild(log.firstChild);
        }
      }

      function connectTrades() {
        if (tradeSocket && tradeSocket.readyState === WebSocket.OPEN) {
          return;
        }

        tradeSocket = new WebSocket(
          "ws://localhost:8080/symbols/AAPL/trades/stream"
        );

        tradeSocket.onopen = () => {
          updateStatus("trade", true);
          logMessage("trade", "Connected to trade stream", "connection");
        };

        tradeSocket.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.type === "trade") {
            const trade = data.trade;
            logMessage(
              "trade",
              `🔥 TRADE EXECUTED: ${trade.qty} shares @ ${trade.px_ticks}`,
              "match"
            );
            logMessage(
              "trade",
              `Maker: ${trade.maker
                .toString()
                .slice(-8)}... | Taker: ${trade.taker.toString().slice(-8)}...`,
              "info"
            );
          } else if (data.type === "ping") {
            tradeSocket.send(
              JSON.stringify({ type: "pong", timestamp: data.timestamp })
            );
          }
        };

        tradeSocket.onclose = () => {
          updateStatus("trade", false);
          logMessage("trade", "Trade stream disconnected", "error");
        };

        tradeSocket.onerror = () => {
          logMessage("trade", "Connection error", "error");
        };
      }

      function connectDepth() {
        if (depthSocket && depthSocket.readyState === WebSocket.OPEN) {
          return;
        }

        depthSocket = new WebSocket(
          "ws://localhost:8080/symbols/AAPL/depth/stream"
        );

        depthSocket.onopen = () => {
          updateStatus("depth", true);
          logMessage("depth", "Connected to depth stream", "connection");
        };

        depthSocket.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.type === "depth") {
            // Update market data display
            document.getElementById("bestBid").textContent =
              data.best_bid || "--";
            document.getElementById("bestAsk").textContent =
              data.best_ask || "--";

            const spread =
              data.best_ask && data.best_bid
                ? data.best_ask - data.best_bid
                : "--";
            document.getElementById("spread").textContent = spread;
            document.getElementById("lastUpdate").textContent = new Date(
              data.timestamp
            ).toLocaleTimeString();

            logMessage(
              "depth",
              `Bid: ${data.best_bid || "None"} | Ask: ${
                data.best_ask || "None"
              }`,
              "depth"
            );
            logMessage(
              "depth",
              `Volume: ${data.bid_size} bids, ${data.ask_size} asks`,
              "info"
            );
          } else if (data.type === "ping") {
            depthSocket.send(
              JSON.stringify({ type: "pong", timestamp: data.timestamp })
            );
          }
        };

        depthSocket.onclose = () => {
          updateStatus("depth", false);
          logMessage("depth", "Depth stream disconnected", "error");
        };

        depthSocket.onerror = () => {
          logMessage("depth", "Connection error", "error");
        };
      }

      function disconnectAll() {
        if (tradeSocket) {
          tradeSocket.close();
          tradeSocket = null;
        }
        if (depthSocket) {
          depthSocket.close();
          depthSocket = null;
        }
      }

      async function submitOrder(symbol, side, price, quantity) {
        const order = { side, price, quantity };

        try {
          const response = await fetch(
            `http://localhost:8080/symbols/${symbol}/orders`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(order),
            }
          );

          const result = await response.json();
          const sideText = side === "Ask" ? "SELL" : "BUY";

          if (result.trades && result.trades.length > 0) {
            logMessage(
              "trade",
              `✅ ${sideText} ${quantity} @ ${price} → FILLED (${result.trades.length} trades)`,
              "match"
            );
          } else {
            logMessage(
              "trade",
              `📝 ${sideText} ${quantity} @ ${price} → RESTED`,
              "info"
            );
          }

          return result;
        } catch (error) {
          logMessage("trade", `❌ Order failed: ${error.message}`, "error");
          throw error;
        }
      }

      async function submitCustomOrder(event) {
        event.preventDefault();

        const symbol = document.getElementById("symbol").value;
        const side = document.getElementById("side").value;
        const price = parseInt(document.getElementById("price").value);
        const quantity = parseInt(document.getElementById("quantity").value);

        await submitOrder(symbol, side, price, quantity);
      }

      async function quickOrder(side, price, quantity) {
        await submitOrder("AAPL", side, price, quantity);
      }

      async function demoMatching() {
        logMessage("trade", "🎯 Starting Price Matching Demo...", "match");

        try {
          // Step 1: Add a resting ask order
          logMessage("trade", "Step 1: Adding resting ASK order...", "info");
          await submitOrder("AAPL", "Ask", 15000, 100);
          await new Promise((resolve) => setTimeout(resolve, 1000));

          // Step 2: Add crossing bid order (should match!)
          logMessage(
            "trade",
            "Step 2: Adding crossing BID order (should match!)...",
            "info"
          );
          await submitOrder("AAPL", "Bid", 15000, 75);
          await new Promise((resolve) => setTimeout(resolve, 1000));

          // Step 3: Add another order that won't match
          logMessage(
            "trade",
            "Step 3: Adding non-crossing BID order...",
            "info"
          );
          await submitOrder("AAPL", "Bid", 14950, 50);

          logMessage(
            "trade",
            "✅ Demo complete! Check the trade stream above for matches.",
            "match"
          );
        } catch (error) {
          logMessage("trade", `❌ Demo failed: ${error.message}`, "error");
        }
      }

      function clearLogs() {
        document.getElementById("tradeLog").innerHTML =
          '<div class="log-entry"><span class="timestamp">Log cleared</span></div>';
        document.getElementById("depthLog").innerHTML =
          '<div class="log-entry"><span class="timestamp">Log cleared</span></div>';
      }

      // Auto-connect on page load
      window.onload = () => {
        setTimeout(() => {
          connectTrades();
          connectDepth();
        }, 1000);
      };

      // Cleanup on page unload
      window.onbeforeunload = () => {
        disconnectAll();
      };
    </script>
  </body>
</html>
